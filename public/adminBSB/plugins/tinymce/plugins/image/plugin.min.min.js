tinymce.PluginManager.add("image",function(h){function j(c,a){var d=document.createElement("img");function e(m,n){if(d.parentNode){d.parentNode.removeChild(d)}a({width:m,height:n})}d.onload=function(){e(Math.max(d.width,d.clientWidth),Math.max(d.height,d.clientHeight))};d.onerror=function(){e()};var b=d.style;b.visibility="hidden";b.position="fixed";b.bottom=b.left=0;b.width=b.height="auto";document.body.appendChild(d);d.src=c}function i(b,d,a){function c(e,l){l=l||[];tinymce.each(e,function(k){var n={text:k.text||k.title};if(k.menu){n.menu=c(k.menu)}else{n.value=k.value;d(n)}l.push(n)});return l}return c(b,a||[])}function f(a){return function(){var b=h.settings.image_list;if(typeof b=="string"){tinymce.util.XHR.send({url:b,success:function(c){a(tinymce.util.JSON.parse(c))}})}else{if(typeof b=="function"){b(a)}else{a(b)}}}}function g(B){var H,a={},y=h.dom,K,A;var C,E,e,I,G=h.settings.image_dimensions!==false;function L(){var l,n,k,m;l=H.find("#width")[0];n=H.find("#height")[0];if(!l||!n){return}k=l.value();m=n.value();if(H.find("#constrain")[0].checked()&&C&&E&&k&&m){if(C!=k){m=Math.round((k/C)*m);if(!isNaN(m)){n.value(m)}}else{k=Math.round((m/E)*k);if(!isNaN(k)){l.value(k)}}}C=k;E=m}function F(){var l,k;function m(n){function o(){n.onload=n.onerror=null;if(h.selection){h.selection.select(n);h.nodeChanged()}}n.onload=function(){if(!a.width&&!a.height&&G){y.setAttribs(n,{width:n.clientWidth,height:n.clientHeight})}o()};n.onerror=o}D();L();a=tinymce.extend(a,H.toJSON());if(!a.alt){a.alt=""}if(!a.title){a.title=""}if(a.width===""){a.width=null}if(a.height===""){a.height=null}if(!a.style){a.style=null}a={src:a.src,alt:a.alt,title:a.title,width:a.width,height:a.height,style:a.style,caption:a.caption,"class":a["class"]};h.undoManager.transact(function(){if(!a.src){if(K){y.remove(K);h.focus();h.nodeChanged()}return}if(a.title===""){a.title=null}if(!K){a.id="__mcenew";h.focus();h.selection.setContent(y.createHTML("img",a));K=y.get("__mcenew");y.setAttrib(K,"id",null)}else{y.setAttribs(K,a)}h.editorUpload.uploadImagesAuto();if(a.caption===false){if(y.is(K.parentNode,"figure.image")){l=K.parentNode;y.insertAfter(K,l);y.remove(l)}}function n(p){return h.schema.getTextBlockElements()[p.nodeName]}if(a.caption===true){if(!y.is(K.parentNode,"figure.image")){k=K;K=K.cloneNode(true);l=y.create("figure",{"class":"image"});l.appendChild(K);l.appendChild(y.create("figcaption",{contentEditable:true},"Caption"));l.contentEditable=false;var o=y.getParent(k,n);if(o){y.split(o,k,l)}else{y.replace(l,k)}h.selection.select(l)}return}m(K)})}function b(k){if(k){k=k.replace(/px$/,"")}return k}function z(o){var m,l,n,k=o.meta||{};if(e){e.value(h.convertURL(this.value(),"src"))}tinymce.each(k,function(p,q){H.find("#"+q).value(p)});if(!k.width&&!k.height){m=h.convertURL(this.value(),"src");l=h.settings.image_prepend_url;n=new RegExp("^(?:[a-z]+:)?//","i");if(l&&!n.test(m)&&m.substring(0,l.length)!==l){m=l+m}this.value(m);j(h.documentBaseURI.toAbsolute(this.value()),function(p){if(p.width&&p.height&&G){C=p.width;E=p.height;H.find("#width").value(C);H.find("#height").value(E)}})}}K=h.selection.getNode();A=y.getParent(K,"figure.image");if(A){K=y.select("img",A)[0]}if(K&&(K.nodeName!="IMG"||K.getAttribute("data-mce-object")||K.getAttribute("data-mce-placeholder"))){K=null}if(K){C=y.getAttrib(K,"width");E=y.getAttrib(K,"height");a={src:y.getAttrib(K,"src"),alt:y.getAttrib(K,"alt"),title:y.getAttrib(K,"title"),"class":y.getAttrib(K,"class"),width:C,height:E,caption:!!A}}if(B){e={type:"listbox",label:"Image list",values:i(B,function(k){k.value=h.convertURL(k.value||k.url,"src")},[{text:"None",value:""}]),value:a.src&&h.convertURL(a.src,"src"),onselect:function(l){var k=H.find("#alt");if(!k.value()||(l.lastControl&&k.value()==l.lastControl.text())){k.value(l.control.text())}H.find("#src").value(l.control.value()).fire("change")},onPostRender:function(){e=this}}}if(h.settings.image_class_list){I={name:"class",type:"listbox",label:"Class",values:i(h.settings.image_class_list,function(k){if(k.value){k.textStyle=function(){return h.formatter.getCssText({inline:"img",classes:[k.value]})}}})}}var c=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:true,onchange:z},e];if(h.settings.image_description!==false){c.push({name:"alt",type:"textbox",label:"Image description"})}if(h.settings.image_title){c.push({name:"title",type:"textbox",label:"Image Title"})}if(G){c.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:L,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:L,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]})}c.push(I);if(h.settings.image_caption&&tinymce.Env.ceFalse){c.push({name:"caption",type:"checkbox",label:"Caption"})}function d(k){if(k.margin){var l=k.margin.split(" ");switch(l.length){case 1:k["margin-top"]=k["margin-top"]||l[0];k["margin-right"]=k["margin-right"]||l[0];k["margin-bottom"]=k["margin-bottom"]||l[0];k["margin-left"]=k["margin-left"]||l[0];break;case 2:k["margin-top"]=k["margin-top"]||l[0];k["margin-right"]=k["margin-right"]||l[1];k["margin-bottom"]=k["margin-bottom"]||l[0];k["margin-left"]=k["margin-left"]||l[1];break;case 3:k["margin-top"]=k["margin-top"]||l[0];k["margin-right"]=k["margin-right"]||l[1];k["margin-bottom"]=k["margin-bottom"]||l[2];k["margin-left"]=k["margin-left"]||l[1];break;case 4:k["margin-top"]=k["margin-top"]||l[0];k["margin-right"]=k["margin-right"]||l[1];k["margin-bottom"]=k["margin-bottom"]||l[2];k["margin-left"]=k["margin-left"]||l[3]}delete k.margin}return k}function D(){function k(n){if(n.length>0&&/^[0-9]+$/.test(n)){n+="px"}return n}if(!h.settings.image_advtab){return}var l=H.toJSON(),m=y.parseStyle(l.style);m=d(m);if(l.vspace){m["margin-top"]=m["margin-bottom"]=k(l.vspace)}if(l.hspace){m["margin-left"]=m["margin-right"]=k(l.hspace)}if(l.border){m["border-width"]=k(l.border)}H.find("#style").value(y.serializeStyle(y.parseStyle(y.serializeStyle(m))))}function J(){if(!h.settings.image_advtab){return}var k=H.toJSON(),l=y.parseStyle(k.style);H.find("#vspace").value("");H.find("#hspace").value("");l=d(l);if((l["margin-top"]&&l["margin-bottom"])||(l["margin-right"]&&l["margin-left"])){if(l["margin-top"]===l["margin-bottom"]){H.find("#vspace").value(b(l["margin-top"]))}else{H.find("#vspace").value("")}if(l["margin-right"]===l["margin-left"]){H.find("#hspace").value(b(l["margin-right"]))}else{H.find("#hspace").value("")}}if(l["border-width"]){H.find("#border").value(b(l["border-width"]))}H.find("#style").value(y.serializeStyle(y.parseStyle(y.serializeStyle(l))))}if(h.settings.image_advtab){if(K){if(K.style.marginLeft&&K.style.marginRight&&K.style.marginLeft===K.style.marginRight){a.hspace=b(K.style.marginLeft)}if(K.style.marginTop&&K.style.marginBottom&&K.style.marginTop===K.style.marginBottom){a.vspace=b(K.style.marginTop)}if(K.style.borderWidth){a.border=b(K.style.borderWidth)}a.style=h.dom.serializeStyle(h.dom.parseStyle(h.dom.getAttrib(K,"style")))}H=h.windowManager.open({title:"Insert/edit image",data:a,bodyType:"tabpanel",body:[{title:"General",type:"form",items:c},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:J},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:D},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:F})}else{H=h.windowManager.open({title:"Insert/edit image",data:a,body:c,onSubmit:F})}}h.on("preInit",function(){function a(c){var d=c.attr("class");return d&&/\bimage\b/.test(d)}function b(c){return function(n){var e=n.length,d;function o(k){k.attr("contenteditable",c?"true":null)}while(e--){d=n[e];if(a(d)){d.attr("contenteditable",c?"false":null);tinymce.each(d.getAll("figcaption"),o)}}}}h.parser.addNodeFilter("figure",b(true));h.serializer.addNodeFilter("figure",b(false))});h.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:f(g),stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"});h.addMenuItem("image",{icon:"image",text:"Insert/edit image",onclick:f(g),context:"insert",prependToContext:true});h.addCommand("mceImage",f(g))});