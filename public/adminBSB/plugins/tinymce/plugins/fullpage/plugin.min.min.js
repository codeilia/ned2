tinymce.PluginManager.add("fullpage",function(u){var o=tinymce.each,s=tinymce.html.Node;var q,n;function p(){var a=m();u.windowManager.open({title:"Document properties",data:a,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(b){r(tinymce.extend(a,b.data))}})}function m(){var e=t(),c={},b,d;function a(f,h){var g=f.attr(h);return g||""}c.fontface=u.getParam("fullpage_default_fontface","");c.fontsize=u.getParam("fullpage_default_fontsize","");b=e.firstChild;if(b.type==7){c.xml_pi=true;d=/encoding="([^"]+)"/.exec(b.value);if(d){c.docencoding=d[1]}}b=e.getAll("#doctype")[0];if(b){c.doctype="<!DOCTYPE"+b.value+">"}b=e.getAll("title")[0];if(b&&b.firstChild){c.title=b.firstChild.value}o(e.getAll("meta"),function(f){var h=f.attr("name"),i=f.attr("http-equiv"),g;if(h){c[h.toLowerCase()]=f.attr("content")}else{if(i=="Content-Type"){g=/charset\s*=\s*(.*)\s*/gi.exec(f.attr("content"));if(g){c.docencoding=g[1]}}}});b=e.getAll("html")[0];if(b){c.langcode=a(b,"lang")||a(b,"xml:lang")}c.stylesheets=[];tinymce.each(e.getAll("link"),function(f){if(f.attr("rel")=="stylesheet"){c.stylesheets.push(f.attr("href"))}});b=e.getAll("body")[0];if(b){c.langdir=a(b,"dir");c.style=a(b,"style");c.visited_color=a(b,"vlink");c.link_color=a(b,"link");c.active_color=a(b,"alink")}return c}function r(b){var c,e,j,h,g,d=u.dom;function f(z,l,k){z.attr(l,k?k:undefined)}function i(k){if(e.firstChild){e.insert(k,e.firstChild)}else{e.append(k)}}c=t();e=c.getAll("head")[0];if(!e){h=c.getAll("html")[0];e=new s("head",1);if(h.firstChild){h.insert(e,h.firstChild,true)}else{h.append(e)}}h=c.firstChild;if(b.xml_pi){g='version="1.0"';if(b.docencoding){g+=' encoding="'+b.docencoding+'"'}if(h.type!=7){h=new s("xml",7);c.insert(h,c.firstChild,true)}h.value=g}else{if(h&&h.type==7){h.remove()}}h=c.getAll("#doctype")[0];if(b.doctype){if(!h){h=new s("#doctype",10);if(b.xml_pi){c.insert(h,c.firstChild)}else{i(h)}}h.value=b.doctype.substring(9,b.doctype.length-1)}else{if(h){h.remove()}}h=null;o(c.getAll("meta"),function(k){if(k.attr("http-equiv")=="Content-Type"){h=k}});if(b.docencoding){if(!h){h=new s("meta",1);h.attr("http-equiv","Content-Type");h.shortEnded=true;i(h)}h.attr("content","text/html; charset="+b.docencoding)}else{if(h){h.remove()}}h=c.getAll("title")[0];if(b.title){if(!h){h=new s("title",1);i(h)}else{h.empty()}h.append(new s("#text",3)).value=b.title}else{if(h){h.remove()}}o("keywords,description,author,copyright,robots".split(","),function(l){var B=c.getAll("meta"),D,k,C=b[l];for(D=0;D<B.length;D++){k=B[D];if(k.attr("name")==l){if(C){k.attr("content",C)}else{k.remove()}return}}if(C){h=new s("meta",1);h.attr("name",l);h.attr("content",C);h.shortEnded=true;i(h)}});var a={};tinymce.each(c.getAll("link"),function(k){if(k.attr("rel")=="stylesheet"){a[k.attr("href")]=k}});tinymce.each(b.stylesheets,function(k){if(!a[k]){h=new s("link",1);h.attr({rel:"stylesheet",text:"text/css",href:k});h.shortEnded=true;i(h)}delete a[k]});tinymce.each(a,function(k){k.remove()});h=c.getAll("body")[0];if(h){f(h,"dir",b.langdir);f(h,"style",b.style);f(h,"vlink",b.visited_color);f(h,"link",b.link_color);f(h,"alink",b.active_color);d.setAttribs(u.getBody(),{style:b.style,dir:b.dir,vLink:b.visited_color,link:b.link_color,aLink:b.active_color})}h=c.getAll("html")[0];if(h){f(h,"lang",b.langcode);f(h,"xml:lang",b.langcode)}if(!e.firstChild){e.remove()}j=new tinymce.html.Serializer({validate:false,indent:true,apply_source_formatting:true,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(c);q=j.substring(0,j.indexOf("</body>"))}function t(){return new tinymce.html.DomParser({validate:false,root_name:"#document"}).parse(q)}function w(h){var k,f,a=h.content,d,g="",e=u.dom,j;if(h.selection){return}function i(l){return l.replace(/<\/?[A-Z]+/g,function(z){return z.toLowerCase()})}if(h.format=="raw"&&q){return}if(h.source_view&&u.getParam("fullpage_hide_in_source_view")){return}if(a.length===0&&!h.source_view){a=tinymce.trim(q)+"\n"+tinymce.trim(a)+"\n"+tinymce.trim(n)}a=a.replace(/<(\/?)BODY/gi,"<$1body");k=a.indexOf("<body");if(k!=-1){k=a.indexOf(">",k);q=i(a.substring(0,k+1));f=a.indexOf("</body",k);if(f==-1){f=a.length}h.content=a.substring(k+1,f);n=i(a.substring(f))}else{q=x();n="\n</body>\n</html>"}d=t();o(d.getAll("style"),function(l){if(l.firstChild){g+=l.firstChild.value}});j=d.getAll("body")[0];if(j){e.setAttribs(u.getBody(),{style:j.attr("style")||"",dir:j.attr("dir")||"",vLink:j.attr("vlink")||"",link:j.attr("link")||"",aLink:j.attr("alink")||""})}e.remove("fullpage_styles");var b=u.getDoc().getElementsByTagName("head")[0];if(g){e.add(b,"style",{id:"fullpage_styles"},g);j=e.get("fullpage_styles");if(j.styleSheet){j.styleSheet.cssText=g}}var c={};tinymce.each(b.getElementsByTagName("link"),function(l){if(l.rel=="stylesheet"&&l.getAttribute("data-mce-fullpage")){c[l.href]=l}});tinymce.each(d.getAll("link"),function(z){var l=z.attr("href");if(!c[l]&&z.attr("rel")=="stylesheet"){e.add(b,"link",{rel:"stylesheet",text:"text/css",href:l,"data-mce-fullpage":"1"})}delete c[l]});tinymce.each(c,function(l){l.parentNode.removeChild(l)})}function x(){var b="",c,a="";if(u.getParam("fullpage_default_xml_pi")){b+='<?xml version="1.0" encoding="'+u.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'}b+=u.getParam("fullpage_default_doctype","<!DOCTYPE html>");b+="\n<html>\n<head>\n";if((c=u.getParam("fullpage_default_title"))){b+="<title>"+c+"</title>\n"}if((c=u.getParam("fullpage_default_encoding"))){b+='<meta http-equiv="Content-Type" content="text/html; charset='+c+'" />\n'}if((c=u.getParam("fullpage_default_font_family"))){a+="font-family: "+c+";"}if((c=u.getParam("fullpage_default_font_size"))){a+="font-size: "+c+";"}if((c=u.getParam("fullpage_default_text_color"))){a+="color: "+c+";"}b+="</head>\n<body"+(a?' style="'+a+'"':"")+">\n";return b}function v(a){if(!a.selection&&(!a.source_view||!u.getParam("fullpage_hide_in_source_view"))){a.content=tinymce.trim(q)+"\n"+tinymce.trim(a.content)+"\n"+tinymce.trim(n)}}u.addCommand("mceFullPageProperties",p);u.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"});u.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"});u.on("BeforeSetContent",w);u.on("GetContent",v)});