(function(){function d(e){this.editor=e;this.loaders=[]}function c(f,h,e){var g=f.config.fileTools_defaultFileName;this.editor=f;this.lang=f.lang;"string"===typeof h?(this.data=h,this.file=a(this.data),this.loaded=this.total=this.file.size):(this.data=null,this.file=h,this.total=this.file.size,this.loaded=0);e?this.fileName=e:this.file.name?this.fileName=this.file.name:(f=this.file.type.split("/"),g&&(f[0]=g),this.fileName=f.join("."));this.uploaded=0;this.uploadTotal=null;this.status="created";this.abort=function(){this.changeStatus("abort")}}function a(h){var n=h.match(b)[1];h=h.replace(b,"");h=atob(h);var g=[],m,l,j,i;for(m=0;m<h.length;m+=512){l=h.slice(m,m+512);j=Array(l.length);for(i=0;i<l.length;i++){j[i]=l.charCodeAt(i)}l=new Uint8Array(j);g.push(l)}return new Blob(g,{type:n})}CKEDITOR.plugins.add("filetools",{lang:"cs,da,de,de-ch,en,eo,eu,fr,gl,id,it,km,ko,ku,nb,nl,pl,pt-br,ru,sv,tr,ug,uk,zh,zh-cn",beforeInit:function(e){e.uploadRepository=new d(e);e.on("fileUploadRequest",function(f){f=f.data.fileLoader;f.xhr.open("POST",f.uploadUrl,!0)},null,null,5);e.on("fileUploadRequest",function(g){g=g.data.fileLoader;var f=new FormData;f.append("upload",g.file,g.fileName);f.append("ckCsrfToken",CKEDITOR.tools.getCsrfToken());g.xhr.send(f)},null,null,999);e.on("fileUploadResponse",function(h){var g=h.data.fileLoader,m=g.xhr,l=h.data;try{var j=JSON.parse(m.responseText);j.error&&j.error.message&&(l.message=j.error.message);j.uploaded?(l.fileName=j.fileName,l.url=j.url):h.cancel()}catch(i){l.message=g.lang.filetools.responseError,CKEDITOR.warn("filetools-response-error",{responseText:m.responseText}),h.cancel()}},null,null,999)}});d.prototype={create:function(f,h){var e=this.loaders.length,g=new c(this.editor,f,h);g.id=e;this.loaders[e]=g;this.fire("instanceCreated",g);return g},isFinished:function(){for(var e=0;e<this.loaders.length;++e){if(!this.loaders[e].isFinished()){return !1}}return !0}};c.prototype={loadAndUpload:function(e){var f=this;this.once("loaded",function(g){g.cancel();f.once("update",function(h){h.cancel()},null,null,0);f.upload(e)},null,null,0);this.load()},load:function(){var e=this,f=this.reader=new FileReader;e.changeStatus("loading");this.abort=function(){e.reader.abort()};f.onabort=function(){e.changeStatus("abort")};f.onerror=function(){e.message=e.lang.filetools.loadError;e.changeStatus("error")};f.onprogress=function(g){e.loaded=g.loaded;e.update()};f.onload=function(){e.loaded=e.total;e.data=f.result;e.changeStatus("loaded")};f.readAsDataURL(this.file)},upload:function(e){e?(this.uploadUrl=e,this.xhr=new XMLHttpRequest,this.attachRequestListeners(),this.editor.fire("fileUploadRequest",{fileLoader:this})&&this.changeStatus("uploading")):(this.message=this.lang.filetools.noUrlError,this.changeStatus("error"))},attachRequestListeners:function(){function f(){"error"!=e.status&&(e.message=e.lang.filetools.networkError,e.changeStatus("error"))}function h(){"abort"!=e.status&&e.changeStatus("abort")}var e=this,g=this.xhr;e.abort=function(){g.abort()};g.onerror=f;g.onabort=h;g.upload?(g.upload.onprogress=function(i){i.lengthComputable&&(e.uploadTotal||(e.uploadTotal=i.total),e.uploaded=i.loaded,e.update())},g.upload.onerror=f,g.upload.onabort=h):(e.uploadTotal=e.total,e.update());g.onload=function(){e.update();if("abort"!=e.status){if(e.uploaded=e.uploadTotal,200>g.status||299<g.status){e.message=e.lang.filetools["httpError"+g.status],e.message||(e.message=e.lang.filetools.httpError.replace("%1",g.status)),e.changeStatus("error")}else{for(var i={fileLoader:e},n=["message","fileName","url"],j=e.editor.fire("fileUploadResponse",i),m=0;m<n.length;m++){var l=n[m];"string"===typeof i[l]&&(e[l]=i[l])}!1===j?e.changeStatus("error"):e.changeStatus("uploaded")}}}},changeStatus:function(e){this.status=e;if("error"==e||"abort"==e||"loaded"==e||"uploaded"==e){this.abort=function(){}}this.fire(e);this.update()},update:function(){this.fire("update")},isFinished:function(){return !!this.status.match(/^(?:loaded|uploaded|error|abort)$/)}};CKEDITOR.event.implementOn(d.prototype);CKEDITOR.event.implementOn(c.prototype);var b=/^data:(\S*?);base64,/;CKEDITOR.fileTools||(CKEDITOR.fileTools={});CKEDITOR.tools.extend(CKEDITOR.fileTools,{uploadRepository:d,fileLoader:c,getUploadUrl:function(f,g){var e=CKEDITOR.tools.capitalize;return g&&f[g+"UploadUrl"]?f[g+"UploadUrl"]:f.uploadUrl?f.uploadUrl:g&&f["filebrowser"+e(g,1)+"UploadUrl"]?f["filebrowser"+e(g,1)+"UploadUrl"]+"\x26responseType\x3djson":f.filebrowserUploadUrl?f.filebrowserUploadUrl+"\x26responseType\x3djson":null},isTypeSupported:function(e,f){return !!e.type.match(f)}})})();