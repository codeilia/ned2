(function(){CKEDITOR.on("dialogDefinition",function(m){var l;l=m.data.name;m=m.data.definition;"link"==l?(m.removeContents("target"),m.removeContents("upload"),m.removeContents("advanced"),l=m.getContents("info"),l.remove("emailSubject"),l.remove("emailBody")):"image"==l&&(m.removeContents("advanced"),l=m.getContents("Link"),l.remove("cmbTarget"),l=m.getContents("info"),l.remove("txtAlt"),l.remove("basic"))});var i={b:"strong",u:"u",i:"em",color:"span",size:"span",quote:"blockquote",code:"code",url:"a",email:"span",img:"span","*":"li",list:"ol"},o={strong:"b",b:"b",u:"u",em:"i",i:"i",code:"code",li:"*"},h={strong:"b",em:"i",u:"u",li:"*",ul:"list",ol:"list",code:"code",a:"link",img:"img",blockquote:"quote"},k={color:"color",size:"font-size"},j={url:"href",email:"mailhref",quote:"cite",list:"listType"},g=CKEDITOR.dtd,f=CKEDITOR.tools.extend({table:1},g.$block,g.$listItem,g.$tableContent,g.$list),d=/\s*(?:;\s*|$)/,c={smiley:":)",sad:":(",wink:";)",laugh:":D",cheeky:":P",blush:":*)",surprise:":-o",indecision:":|",angry:"\x3e:(",angel:"o:)",cool:"8-)",devil:"\x3e:-)",crying:";(",kiss:":-*"},e={},b=[],s;for(s in c){e[c[s]]=s,b.push(c[s].replace(/\(|\)|\:|\/|\*|\-|\|/g,function(l){return"\\"+l}))}var b=new RegExp(b.join("|"),"g"),a=function(){var m=[],l={nbsp:"Â ",shy:""},n;for(n in l){m.push(n)}m=new RegExp("\x26("+m.join("|")+");","g");return function(q){return q.replace(m,function(r,t){return l[t]})}}();CKEDITOR.BBCodeParser=function(){this._={bbcPartsRegex:/(?:\[([^\/\]=]*?)(?:=([^\]]*?))?\])|(?:\[\/([a-z]{1,16})\])/ig}};CKEDITOR.BBCodeParser.prototype={parse:function(x){for(var w,v,m=0;w=this._.bbcPartsRegex.exec(x);){if(v=w.index,v>m&&(m=x.substring(m,v),this.onText(m,1)),m=this._.bbcPartsRegex.lastIndex,(v=(w[1]||w[3]||"").toLowerCase())&&!i[v]){this.onText(w[0])}else{if(w[1]){var q=i[v],l={},n={};if(w=w[2]){if("list"==v&&(isNaN(w)?/^[a-z]+$/.test(w)?w="lower-alpha":/^[A-Z]+$/.test(w)&&(w="upper-alpha"):w="decimal"),k[v]){"size"==v&&(w+="%");n[k[v]]=w;w=l;var r="",t=void 0;for(t in n){var y=(t+":"+n[t]).replace(d,";"),r=r+y}w.style=r}else{j[v]&&(l[j[v]]=CKEDITOR.tools.htmlDecode(w))}}if("email"==v||"img"==v){l.bbcode=v}this.onTagOpen(q,l,CKEDITOR.dtd.$empty[q])}else{if(w[3]){this.onTagClose(i[v])}}}}if(x.length>m){this.onText(x.substring(m,x.length),1)}}};CKEDITOR.htmlParser.fragment.fromBBCode=function(x){function w(z){if(0<n.length){for(var B=0;B<n.length;B++){var u=n[B],D=u.name,A=CKEDITOR.dtd[D],C=t.name&&CKEDITOR.dtd[t.name];C&&!C[D]||z&&A&&!A[z]&&CKEDITOR.dtd[z]||(u=u.clone(),u.parent=t,t=u,n.splice(B,1),B--)}}}function v(z,B){var u=t.children.length,C=0<u&&t.children[u-1],u=!C&&p.getRule(h[t.name],"breakAfterOpen"),C=C&&C.type==CKEDITOR.NODE_ELEMENT&&p.getRule(h[C.name],"breakAfterClose"),A=z&&p.getRule(h[z],B?"breakBeforeClose":"breakBeforeOpen");r&&(u||C||A)&&r--;r&&z in f&&r++;for(;r&&r--;){t.children.push(new CKEDITOR.htmlParser.element("br"))}}function m(z,A){v(z.name,1);A=A||t||l;var u=A.children.length;z.previous=0<u&&A.children[u-1]||null;z.parent=A;A.children.push(z);z.returnPoint&&(t=z.returnPoint,delete z.returnPoint)}var q=new CKEDITOR.BBCodeParser,l=new CKEDITOR.htmlParser.fragment,n=[],r=0,t=l,y;q.onTagOpen=function(A,B){var D=new CKEDITOR.htmlParser.element(A,B);if(CKEDITOR.dtd.$removeEmpty[A]){n.push(D)}else{var z=t.name,C=z&&(CKEDITOR.dtd[z]||(t._.isBlockLike?CKEDITOR.dtd.div:CKEDITOR.dtd.span));if(C&&!C[A]){var C=!1,u;A==z?m(t,t.parent):(A in CKEDITOR.dtd.$listItem?(q.onTagOpen("ul",{}),u=t):(m(t,t.parent),n.unshift(t)),C=!0);t=u?u:t.returnPoint||t.parent;if(C){q.onTagOpen.apply(this,arguments);return}}w(A);v(A);D.parent=t;D.returnPoint=y;y=0;D.isEmpty?m(D):t=D}};q.onTagClose=function(z){for(var A=n.length-1;0<=A;A--){if(z==n[A].name){n.splice(A,1);return}}for(var u=[],C=[],B=t;B.type&&B.name!=z;){B._.isBlockLike||C.unshift(B),u.push(B),B=B.parent}if(B.type){for(A=0;A<u.length;A++){z=u[A],m(z,z.parent)}t=B;m(B,B.parent);B==t&&(t=t.parent);n=n.concat(C)}};q.onText=function(u){var z=CKEDITOR.dtd[t.name];if(!z||z["#"]){v(),w(),u.replace(/(\r\n|[\r\n])|[^\r\n]*/g,function(B,C){if(void 0!==C&&C.length){r++}else{if(B.length){var A=0;B.replace(b,function(D,E){m(new CKEDITOR.htmlParser.text(B.substring(A,E)),t);m(new CKEDITOR.htmlParser.element("smiley",{desc:e[D]}),t);A=E+D.length});A!=B.length&&m(new CKEDITOR.htmlParser.text(B.substring(A,B.length)),t)}}})}};for(q.parse(CKEDITOR.tools.htmlEncode(x));t.type!=CKEDITOR.NODE_DOCUMENT_FRAGMENT;){x=t.parent,m(t,x),t=x}return l};var p=new (CKEDITOR.tools.createClass({$:function(){this._={output:[],rules:[]};this.setRules("list",{breakBeforeOpen:1,breakAfterOpen:1,breakBeforeClose:1,breakAfterClose:1});this.setRules("*",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:1,breakAfterClose:0});this.setRules("quote",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:0,breakAfterClose:1})},proto:{setRules:function(m,l){var n=this._.rules[m];n?CKEDITOR.tools.extend(n,l,!0):this._.rules[m]=l},getRule:function(m,l){return this._.rules[m]&&this._.rules[m][l]},openTag:function(l){l in i&&(this.getRule(l,"breakBeforeOpen")&&this.lineBreak(1),this.write("[",l))},openTagClose:function(l){"br"==l?this._.output.push("\n"):l in i&&(this.write("]"),this.getRule(l,"breakAfterOpen")&&this.lineBreak(1))},attribute:function(m,l){"option"==m&&this.write("\x3d",l)},closeTag:function(l){l in i&&(this.getRule(l,"breakBeforeClose")&&this.lineBreak(1),"*"!=l&&this.write("[/",l,"]"),this.getRule(l,"breakAfterClose")&&this.lineBreak(1))},text:function(l){this.write(l)},comment:function(){},lineBreak:function(){!this._.hasLineBreak&&this._.output.length&&(this.write("\n"),this._.hasLineBreak=1)},write:function(){this._.hasLineBreak=0;var l=Array.prototype.join.call(arguments,"");this._.output.push(l)},reset:function(){this._.output=[];this._.hasLineBreak=0},getHtml:function(m){var l=this._.output.join("");m&&this.reset();return a(l)}}}));CKEDITOR.plugins.add("bbcode",{requires:"entities",beforeInit:function(l){CKEDITOR.tools.extend(l.config,{enterMode:CKEDITOR.ENTER_BR,basicEntities:!1,entities:!1,fillEmptyBlocks:!1},!0);l.filter.disable();l.activeEnterMode=l.enterMode=CKEDITOR.ENTER_BR},init:function(m){function l(t){var r=t.data;t=CKEDITOR.htmlParser.fragment.fromBBCode(t.data.dataValue);var u=new CKEDITOR.htmlParser.basicWriter;t.writeHtml(u,n);t=u.getHtml(!0);r.dataValue=t}var q=m.config,n=new CKEDITOR.htmlParser.filter;n.addRules({elements:{blockquote:function(t){var r=new CKEDITOR.htmlParser.element("div");r.children=t.children;t.children=[r];if(r=t.attributes.cite){var u=new CKEDITOR.htmlParser.element("cite");u.add(new CKEDITOR.htmlParser.text(r.replace(/^"|"$/g,"")));delete t.attributes.cite;t.children.unshift(u)}},span:function(t){var r;if(r=t.attributes.bbcode){"img"==r?(t.name="img",t.attributes.src=t.children[0].value,t.children=[]):"email"==r&&(t.name="a",t.attributes.href="mailto:"+t.children[0].value),delete t.attributes.bbcode}},ol:function(r){r.attributes.listType?"decimal"!=r.attributes.listType&&(r.attributes.style="list-style-type:"+r.attributes.listType):r.name="ul";delete r.attributes.listType},a:function(r){r.attributes.href||(r.attributes.href=r.children[0].value)},smiley:function(t){t.name="img";var r=t.attributes.desc,u=q.smiley_images[CKEDITOR.tools.indexOf(q.smiley_descriptions,r)],u=CKEDITOR.tools.htmlEncode(q.smiley_path+u);t.attributes={src:u,"data-cke-saved-src":u,title:r,alt:r}}}});m.dataProcessor.htmlFilter.addRules({elements:{$:function(A){var z=A.attributes,w=CKEDITOR.tools.parseCssText(z.style,1),x,y=A.name;if(y in o){y=o[y]}else{if("span"==y){if(x=w.color){y="color",x=CKEDITOR.tools.convertRgbToHex(x)}else{if(x=w["font-size"]){if(z=x.match(/(\d+)%$/)){x=z[1],y="size"}}}}else{if("ol"==y||"ul"==y){if(x=w["list-style-type"]){switch(x){case"lower-alpha":x="a";break;case"upper-alpha":x="A"}}else{"ol"==y&&(x=1)}y="list"}else{if("blockquote"==y){try{var v=A.children[0],u=A.children[1],t="cite"==v.name&&v.children[0].value;t&&(x='"'+t+'"',A.children=u.children)}catch(r){}y="quote"}else{if("a"==y){if(x=z.href){-1!==x.indexOf("mailto:")?(y="email",A.children=[new CKEDITOR.htmlParser.text(x.replace("mailto:",""))],x=""):((y=1==A.children.length&&A.children[0])&&y.type==CKEDITOR.NODE_TEXT&&y.value==x&&(x=""),y="url")}}else{if("img"==y){A.isEmpty=0;w=z["data-cke-saved-src"]||z.src;z=z.alt;if(w&&-1!=w.indexOf(m.config.smiley_path)&&z){return new CKEDITOR.htmlParser.text(c[z])}A.children=[new CKEDITOR.htmlParser.text(w)]}}}}}}A.name=y;x&&(A.attributes.option=x);return null},br:function(r){if((r=r.next)&&r.name in f){return !1}}}},1);m.dataProcessor.writer=p;if(m.elementMode==CKEDITOR.ELEMENT_MODE_INLINE){m.once("contentDom",function(){m.on("setData",l)})}else{m.on("setData",l)}},afterInit:function(m){var l;m._.elementsPath&&(l=m._.elementsPath.filters)&&l.push(function(n){var q=n.getName(),r=h[q]||!1;"link"==r&&0===n.getAttribute("href").indexOf("mailto:")?r="email":"span"==q?n.getStyle("font-size")?r="size":n.getStyle("color")&&(r="color"):"img"==r&&(n=n.data("cke-saved-src")||n.getAttribute("src"))&&0===n.indexOf(m.config.smiley_path)&&(r="smiley");return r})}})})();