tinymce.PluginManager.add("layer",function(j){function i(a){do{if(a.className&&a.className.indexOf("mceItemLayer")!=-1){return a}}while((a=a.parentNode))}function h(b){var a=j.dom;tinymce.each(a.select("div,p",b),function(c){if(/^(absolute|relative|fixed)$/i.test(c.style.position)){if(c.hasVisual){a.addClass(c,"mceItemVisualAid")}else{a.removeClass(c,"mceItemVisualAid")}a.addClass(c,"mceItemLayer")}})}function l(a){var c,b=[],d=i(j.selection.getNode()),e=-1,o=-1,f;f=[];tinymce.walk(j.getBody(),function(m){if(m.nodeType==1&&/^(absolute|relative|static)$/i.test(m.style.position)){f.push(m)}},"childNodes");for(c=0;c<f.length;c++){b[c]=f[c].style.zIndex?parseInt(f[c].style.zIndex,10):0;if(e<0&&f[c]==d){e=c}}if(a<0){for(c=0;c<b.length;c++){if(b[c]<b[e]){o=c;break}}if(o>-1){f[e].style.zIndex=b[o];f[o].style.zIndex=b[e]}else{if(b[e]>0){f[e].style.zIndex=b[e]-1}}}else{for(c=0;c<b.length;c++){if(b[c]>b[e]){o=c;break}}if(o>-1){f[e].style.zIndex=b[o];f[o].style.zIndex=b[e]}else{f[e].style.zIndex=b[e]+1}}j.execCommand("mceRepaint")}function g(){var a=j.dom,b=a.getPos(a.getParent(j.selection.getNode(),"*"));var c=j.getBody();j.dom.add(c,"div",{style:{position:"absolute",left:b.x,top:(b.y>20?b.y:20),width:100,height:100},"class":"mceItemVisualAid mceItemLayer"},j.selection.getContent()||j.getLang("layer.content"));if(tinymce.Env.ie){a.setHTML(c,c.innerHTML)}}function k(){var a=i(j.selection.getNode());if(!a){a=j.dom.getParent(j.selection.getNode(),"DIV,P,IMG")}if(a){if(a.style.position.toLowerCase()=="absolute"){j.dom.setStyles(a,{position:"",left:"",top:"",width:"",height:""});j.dom.removeClass(a,"mceItemVisualAid");j.dom.removeClass(a,"mceItemLayer")}else{if(!a.style.left){a.style.left=20+"px"}if(!a.style.top){a.style.top=20+"px"}if(!a.style.width){a.style.width=a.width?(a.width+"px"):"100px"}if(!a.style.height){a.style.height=a.height?(a.height+"px"):"100px"}a.style.position="absolute";j.dom.setAttrib(a,"data-mce-style","");j.addVisual(j.getBody())}j.execCommand("mceRepaint");j.nodeChanged()}}j.addCommand("mceInsertLayer",g);j.addCommand("mceMoveForward",function(){l(1)});j.addCommand("mceMoveBackward",function(){l(-1)});j.addCommand("mceMakeAbsolute",function(){k()});j.addButton("moveforward",{title:"layer.forward_desc",cmd:"mceMoveForward"});j.addButton("movebackward",{title:"layer.backward_desc",cmd:"mceMoveBackward"});j.addButton("absolute",{title:"layer.absolute_desc",cmd:"mceMakeAbsolute"});j.addButton("insertlayer",{title:"layer.insertlayer_desc",cmd:"mceInsertLayer"});j.on("init",function(){if(tinymce.Env.ie){j.getDoc().execCommand("2D-Position",false,true)}});j.on("mouseup",function(a){var b=i(a.target);if(b){j.dom.setAttrib(b,"data-mce-style","")}});j.on("mousedown",function(a){var c=a.target,b=j.getDoc(),d;if(tinymce.Env.gecko){if(i(c)){if(b.designMode!=="on"){b.designMode="on";c=b.body;d=c.parentNode;d.removeChild(c);d.appendChild(c)}}else{if(b.designMode=="on"){b.designMode="off"}}}});j.on("NodeChange",h)});