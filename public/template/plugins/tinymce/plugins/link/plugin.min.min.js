tinymce.PluginManager.add("link",function(g){function e(a){return function(){var b=g.settings.link_list;if(typeof b=="string"){tinymce.util.XHR.send({url:b,success:function(c){a(tinymce.util.JSON.parse(c))}})}else{if(typeof b=="function"){b(a)}else{a(b)}}}}function h(b,d,a){function c(k,l){l=l||[];tinymce.each(k,function(i){var j={text:i.text||i.title};if(i.menu){j.menu=c(i.menu)}else{j.value=i.value;if(d){d(j)}}l.push(j)});return l}return c(b,a||[])}function f(K){var b={},a=g.selection,A=g.dom,d,G,F;var L,I,J,N,E,H,M,D,C;function z(j){var i=L.find("#text");if(!i.value()||(j.lastControl&&i.value()==j.lastControl.text())){i.value(j.control.text())}L.find("#href").value(j.control.value())}function O(j){var i=[];tinymce.each(g.dom.select("a:not([href])"),function(l){var k=l.name||l.id;if(k){i.push({text:k,value:"#"+k,selected:j.indexOf("#"+k)!=-1})}});if(i.length){i.unshift({text:"None",value:""});return{name:"anchor",type:"listbox",label:"Anchors",values:i,onselect:z}}}function B(){if(!F&&b.text.length===0&&I){this.parent().parent().find("#text")[0].value(this.value())}}function P(i){var j=i.meta||{};if(N){N.value(g.convertURL(this.value(),"href"))}tinymce.each(i.meta,function(k,l){L.find("#"+l).value(k)});if(!j.text){B.call(this)}}function c(i){var k=a.getContent();if(/</.test(k)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(k)||k.indexOf("href=")==-1)){return false}if(i){var j=i.childNodes,l;if(j.length===0){return false}for(l=j.length-1;l>=0;l--){if(j[l].nodeType!=3){return false}}}return true}d=a.getNode();G=A.getParent(d,"a[href]");I=c();b.text=F=G?(G.innerText||G.textContent):a.getContent({format:"text"});b.href=G?A.getAttrib(G,"href"):"";if(G){b.target=A.getAttrib(G,"target")}else{if(g.settings.default_link_target){b.target=g.settings.default_link_target}}if((C=A.getAttrib(G,"rel"))){b.rel=C}if((C=A.getAttrib(G,"class"))){b["class"]=C}if((C=A.getAttrib(G,"title"))){b.title=C}if(I){J={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){b.text=this.value()}}}if(K){N={type:"listbox",label:"Link list",values:h(K,function(i){i.value=g.convertURL(i.value||i.url,"href")},[{text:"None",value:""}]),onselect:z,value:g.convertURL(b.href,"href"),onPostRender:function(){N=this}}}if(g.settings.target_list!==false){if(!g.settings.target_list){g.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]}H={name:"target",type:"listbox",label:"Target",values:h(g.settings.target_list)}}if(g.settings.rel_list){E={name:"rel",type:"listbox",label:"Rel",values:h(g.settings.rel_list)}}if(g.settings.link_class_list){M={name:"class",type:"listbox",label:"Class",values:h(g.settings.link_class_list,function(i){if(i.value){i.textStyle=function(){return g.formatter.getCssText({inline:"a",classes:[i.value]})}}})}}if(g.settings.link_title!==false){D={name:"title",type:"textbox",label:"Title",value:b.title}}L=g.windowManager.open({title:"Insert link",data:b,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:true,label:"Url",onchange:P,onkeyup:B},J,D,O(b.href),N,E,H,M],onSubmit:function(k){var j;b=tinymce.extend(b,k.data);j=b.href;function l(n,m){var o=g.selection.getRng();tinymce.util.Delay.setEditorTimeout(g,function(){g.windowManager.confirm(n,function(p){g.selection.setRng(o);m(p)})})}function i(){var m={href:j,target:b.target?b.target:null,rel:b.rel?b.rel:null,"class":b["class"]?b["class"]:null,title:b.title?b.title:null};if(G){g.focus();if(I&&b.text!=F){if("innerText" in G){G.innerText=b.text}else{G.textContent=b.text}}A.setAttribs(G,m);a.select(G);g.undoManager.add()}else{if(I){g.insertContent(A.createHTML("a",m,A.encode(b.text)))}else{g.execCommand("mceInsertLink",false,m)}}}if(!j){g.execCommand("unlink");return}if(j.indexOf("@")>0&&j.indexOf("//")==-1&&j.indexOf("mailto:")==-1){l("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(m){if(m){j="mailto:"+j}i()});return}if((g.settings.link_assume_external_targets&&!/^\w+:/i.test(j))||(!g.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(j))){l("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(m){if(m){j="http://"+j}i()});return}i()}})}g.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:e(f),stateSelector:"a[href]"});g.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"});g.addShortcut("Meta+K","",e(f));g.addCommand("mceLink",e(f));this.showDialog=f;g.addMenuItem("link",{icon:"link",text:"Insert/edit link",shortcut:"Meta+K",onclick:e(f),stateSelector:"a[href]",context:"insert",prependToContext:true})});