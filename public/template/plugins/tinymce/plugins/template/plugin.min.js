tinymce.PluginManager.add("template",function(e){var g=tinymce.each;function f(i){return function(){var j=e.settings.templates;if(typeof j=="function"){j(i);return}if(typeof j=="string"){tinymce.util.XHR.send({url:j,success:function(k){i(tinymce.util.JSON.parse(k))}})}else{i(j)}}}function a(l){var n,k=[],j;if(!l||l.length===0){var m=e.translate("No templates defined.");e.notificationManager.open({text:m,type:"info"});return}tinymce.each(l,function(o){k.push({selected:!k.length,text:o.title,value:{url:o.url,content:o.content,description:o.description}})});function i(q){var p=q.control.value();function o(s){if(s.indexOf("<html>")==-1){var u="";tinymce.each(e.contentCSS,function(v){u+='<link type="text/css" rel="stylesheet" href="'+e.documentBaseURI.toAbsolute(v)+'">'});var r=e.settings.body_class||"";if(r.indexOf("=")!=-1){r=e.getParam("body_class","","hash");r=r[e.id]||""}s=("<!DOCTYPE html><html><head>"+u+'</head><body class="'+r+'">'+s+"</body></html>")}s=d(s,"template_preview_replace_values");var t=n.find("iframe")[0].getEl().contentWindow.document;t.open();t.write(s);t.close()}if(p.url){tinymce.util.XHR.send({url:p.url,success:function(r){j=r;o(j)}})}else{j=p.content;o(j)}n.find("#description")[0].text(q.control.value().description)}n=e.windowManager.open({title:"Insert template",layout:"flex",direction:"column",align:"stretch",padding:15,spacing:10,items:[{type:"form",flex:0,padding:0,items:[{type:"container",label:"Templates",items:{type:"listbox",label:"Templates",name:"template",values:k,onselect:i}}]},{type:"label",name:"description",label:"Description",text:"\u00a0"},{type:"iframe",flex:1,border:1}],onsubmit:function(){c(false,j)},width:e.getParam("template_popup_width",600),height:e.getParam("template_popup_height",500)});n.find("listbox")[0].fire("select")}function b(j,m){var i="Sun Mon Tue Wed Thu Fri Sat Sun".split(" ");var o="Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" ");var n="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ");var l="January February March April May June July August September October November December".split(" ");function k(r,p){r=""+r;if(r.length<p){for(var q=0;q<(p-r.length);q++){r="0"+r}}return r}m=m||new Date();j=j.replace("%D","%m/%d/%Y");j=j.replace("%r","%I:%M:%S %p");j=j.replace("%Y",""+m.getFullYear());j=j.replace("%y",""+m.getYear());j=j.replace("%m",k(m.getMonth()+1,2));j=j.replace("%d",k(m.getDate(),2));j=j.replace("%H",""+k(m.getHours(),2));j=j.replace("%M",""+k(m.getMinutes(),2));j=j.replace("%S",""+k(m.getSeconds(),2));j=j.replace("%I",""+((m.getHours()+11)%12+1));j=j.replace("%p",""+(m.getHours()<12?"AM":"PM"));j=j.replace("%B",""+e.translate(l[m.getMonth()]));j=j.replace("%b",""+e.translate(n[m.getMonth()]));j=j.replace("%A",""+e.translate(o[m.getDay()]));j=j.replace("%a",""+e.translate(i[m.getDay()]));j=j.replace("%%","%");return j}function h(j){var k=e.dom,i=e.getParam("template_replace_values");g(k.select("*",j),function(l){g(i,function(n,m){if(k.hasClass(l,m)){if(typeof i[m]=="function"){i[m](l)}}})})}function d(i,j){g(e.getParam(j),function(m,l){if(typeof m=="function"){m=m(l)}i=i.replace(new RegExp("\\{\\$"+l+"\\}","g"),m)});return i}function c(m,j){var k,p,o=e.dom,l=e.selection.getContent();j=d(j,"template_replace_values");k=o.create("div",null,j);p=o.select(".mceTmpl",k);if(p&&p.length>0){k=o.create("div",null);k.appendChild(p[0].cloneNode(true))}function i(r,q){return new RegExp("\\b"+q+"\\b","g").test(r.className)}g(o.select("*",k),function(q){if(i(q,e.getParam("template_cdate_classes","cdate").replace(/\s+/g,"|"))){q.innerHTML=b(e.getParam("template_cdate_format",e.getLang("template.cdate_format")))}if(i(q,e.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))){q.innerHTML=b(e.getParam("template_mdate_format",e.getLang("template.mdate_format")))}if(i(q,e.getParam("template_selected_content_classes","selcontent").replace(/\s+/g,"|"))){q.innerHTML=l}});h(k);e.execCommand("mceInsertContent",false,k.innerHTML);e.addVisual()}e.addCommand("mceInsertTemplate",c);e.addButton("template",{title:"Insert template",onclick:f(a)});e.addMenuItem("template",{text:"Insert template",onclick:f(a),context:"insert"});e.on("PreProcess",function(j){var i=e.dom;g(i.select("div",j.node),function(k){if(i.hasClass(k,"mceTmpl")){g(i.select("*",k),function(l){if(i.hasClass(l,e.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))){l.innerHTML=b(e.getParam("template_mdate_format",e.getLang("template.mdate_format")))}});h(k)}})})});