tinymce.PluginManager.add("image",function(e){function c(h,j){var g=document.createElement("img");function f(l,k){if(g.parentNode){g.parentNode.removeChild(g)}j({width:l,height:k})}g.onload=function(){f(Math.max(g.width,g.clientWidth),Math.max(g.height,g.clientHeight))};g.onerror=function(){f()};var i=g.style;i.visibility="hidden";i.position="fixed";i.bottom=i.left=0;i.width=i.height="auto";document.body.appendChild(g);g.src=h}function d(h,f,i){function g(k,j){j=j||[];tinymce.each(k,function(m){var l={text:m.text||m.title};if(m.menu){l.menu=g(m.menu)}else{l.value=m.value;f(l)}j.push(l)});return j}return g(h,i||[])}function b(f){return function(){var g=e.settings.image_list;if(typeof g=="string"){tinymce.util.XHR.send({url:g,success:function(h){f(tinymce.util.JSON.parse(h))}})}else{if(typeof g=="function"){g(f)}else{f(g)}}}}function a(p){var j,x={},s=e.dom,g,q;var o,m,t,i,k=e.settings.image_dimensions!==false;function f(){var z,B,A,y;z=j.find("#width")[0];B=j.find("#height")[0];if(!z||!B){return}A=z.value();y=B.value();if(j.find("#constrain")[0].checked()&&o&&m&&A&&y){if(o!=A){y=Math.round((A/o)*y);if(!isNaN(y)){B.value(y)}}else{A=Math.round((y/m)*A);if(!isNaN(A)){z.value(A)}}}o=A;m=y}function l(){var z,A;function y(C){function B(){C.onload=C.onerror=null;if(e.selection){e.selection.select(C);e.nodeChanged()}}C.onload=function(){if(!x.width&&!x.height&&k){s.setAttribs(C,{width:C.clientWidth,height:C.clientHeight})}B()};C.onerror=B}n();f();x=tinymce.extend(x,j.toJSON());if(!x.alt){x.alt=""}if(!x.title){x.title=""}if(x.width===""){x.width=null}if(x.height===""){x.height=null}if(!x.style){x.style=null}x={src:x.src,alt:x.alt,title:x.title,width:x.width,height:x.height,style:x.style,caption:x.caption,"class":x["class"]};e.undoManager.transact(function(){if(!x.src){if(g){s.remove(g);e.focus();e.nodeChanged()}return}if(x.title===""){x.title=null}if(!g){x.id="__mcenew";e.focus();e.selection.setContent(s.createHTML("img",x));g=s.get("__mcenew");s.setAttrib(g,"id",null)}else{s.setAttribs(g,x)}e.editorUpload.uploadImagesAuto();if(x.caption===false){if(s.is(g.parentNode,"figure.image")){z=g.parentNode;s.insertAfter(g,z);s.remove(z)}}function C(D){return e.schema.getTextBlockElements()[D.nodeName]}if(x.caption===true){if(!s.is(g.parentNode,"figure.image")){A=g;g=g.cloneNode(true);z=s.create("figure",{"class":"image"});z.appendChild(g);z.appendChild(s.create("figcaption",{contentEditable:true},"Caption"));z.contentEditable=false;var B=s.getParent(A,C);if(B){s.split(B,A,z)}else{s.replace(z,A)}e.selection.select(z)}return}y(g)})}function w(y){if(y){y=y.replace(/px$/,"")}return y}function r(B){var C,z,y,A=B.meta||{};if(t){t.value(e.convertURL(this.value(),"src"))}tinymce.each(A,function(E,D){j.find("#"+D).value(E)});if(!A.width&&!A.height){C=e.convertURL(this.value(),"src");z=e.settings.image_prepend_url;y=new RegExp("^(?:[a-z]+:)?//","i");if(z&&!y.test(C)&&C.substring(0,z.length)!==z){C=z+C}this.value(C);c(e.documentBaseURI.toAbsolute(this.value()),function(D){if(D.width&&D.height&&k){o=D.width;m=D.height;j.find("#width").value(o);j.find("#height").value(m)}})}}g=e.selection.getNode();q=s.getParent(g,"figure.image");if(q){g=s.select("img",q)[0]}if(g&&(g.nodeName!="IMG"||g.getAttribute("data-mce-object")||g.getAttribute("data-mce-placeholder"))){g=null}if(g){o=s.getAttrib(g,"width");m=s.getAttrib(g,"height");x={src:s.getAttrib(g,"src"),alt:s.getAttrib(g,"alt"),title:s.getAttrib(g,"title"),"class":s.getAttrib(g,"class"),width:o,height:m,caption:!!q}}if(p){t={type:"listbox",label:"Image list",values:d(p,function(y){y.value=e.convertURL(y.value||y.url,"src")},[{text:"None",value:""}]),value:x.src&&e.convertURL(x.src,"src"),onselect:function(y){var z=j.find("#alt");if(!z.value()||(y.lastControl&&z.value()==y.lastControl.text())){z.value(y.control.text())}j.find("#src").value(y.control.value()).fire("change")},onPostRender:function(){t=this}}}if(e.settings.image_class_list){i={name:"class",type:"listbox",label:"Class",values:d(e.settings.image_class_list,function(y){if(y.value){y.textStyle=function(){return e.formatter.getCssText({inline:"img",classes:[y.value]})}}})}}var v=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:true,onchange:r},t];if(e.settings.image_description!==false){v.push({name:"alt",type:"textbox",label:"Image description"})}if(e.settings.image_title){v.push({name:"title",type:"textbox",label:"Image Title"})}if(k){v.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:f,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:f,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]})}v.push(i);if(e.settings.image_caption&&tinymce.Env.ceFalse){v.push({name:"caption",type:"checkbox",label:"Caption"})}function u(z){if(z.margin){var y=z.margin.split(" ");switch(y.length){case 1:z["margin-top"]=z["margin-top"]||y[0];z["margin-right"]=z["margin-right"]||y[0];z["margin-bottom"]=z["margin-bottom"]||y[0];z["margin-left"]=z["margin-left"]||y[0];break;case 2:z["margin-top"]=z["margin-top"]||y[0];z["margin-right"]=z["margin-right"]||y[1];z["margin-bottom"]=z["margin-bottom"]||y[0];z["margin-left"]=z["margin-left"]||y[1];break;case 3:z["margin-top"]=z["margin-top"]||y[0];z["margin-right"]=z["margin-right"]||y[1];z["margin-bottom"]=z["margin-bottom"]||y[2];z["margin-left"]=z["margin-left"]||y[1];break;case 4:z["margin-top"]=z["margin-top"]||y[0];z["margin-right"]=z["margin-right"]||y[1];z["margin-bottom"]=z["margin-bottom"]||y[2];z["margin-left"]=z["margin-left"]||y[3]}delete z.margin}return z}function n(){function A(B){if(B.length>0&&/^[0-9]+$/.test(B)){B+="px"}return B}if(!e.settings.image_advtab){return}var z=j.toJSON(),y=s.parseStyle(z.style);y=u(y);if(z.vspace){y["margin-top"]=y["margin-bottom"]=A(z.vspace)}if(z.hspace){y["margin-left"]=y["margin-right"]=A(z.hspace)}if(z.border){y["border-width"]=A(z.border)}j.find("#style").value(s.serializeStyle(s.parseStyle(s.serializeStyle(y))))}function h(){if(!e.settings.image_advtab){return}var z=j.toJSON(),y=s.parseStyle(z.style);j.find("#vspace").value("");j.find("#hspace").value("");y=u(y);if((y["margin-top"]&&y["margin-bottom"])||(y["margin-right"]&&y["margin-left"])){if(y["margin-top"]===y["margin-bottom"]){j.find("#vspace").value(w(y["margin-top"]))}else{j.find("#vspace").value("")}if(y["margin-right"]===y["margin-left"]){j.find("#hspace").value(w(y["margin-right"]))}else{j.find("#hspace").value("")}}if(y["border-width"]){j.find("#border").value(w(y["border-width"]))}j.find("#style").value(s.serializeStyle(s.parseStyle(s.serializeStyle(y))))}if(e.settings.image_advtab){if(g){if(g.style.marginLeft&&g.style.marginRight&&g.style.marginLeft===g.style.marginRight){x.hspace=w(g.style.marginLeft)}if(g.style.marginTop&&g.style.marginBottom&&g.style.marginTop===g.style.marginBottom){x.vspace=w(g.style.marginTop)}if(g.style.borderWidth){x.border=w(g.style.borderWidth)}x.style=e.dom.serializeStyle(e.dom.parseStyle(e.dom.getAttrib(g,"style")))}j=e.windowManager.open({title:"Insert/edit image",data:x,bodyType:"tabpanel",body:[{title:"General",type:"form",items:v},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:h},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:n},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:l})}else{j=e.windowManager.open({title:"Insert/edit image",data:x,body:v,onSubmit:l})}}e.on("preInit",function(){function g(i){var h=i.attr("class");return h&&/\bimage\b/.test(h)}function f(h){return function(k){var l=k.length,m;function j(i){i.attr("contenteditable",h?"true":null)}while(l--){m=k[l];if(g(m)){m.attr("contenteditable",h?"false":null);tinymce.each(m.getAll("figcaption"),j)}}}}e.parser.addNodeFilter("figure",f(true));e.serializer.addNodeFilter("figure",f(false))});e.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:b(a),stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"});e.addMenuItem("image",{icon:"image",text:"Insert/edit image",onclick:b(a),context:"insert",prependToContext:true});e.addCommand("mceImage",b(a))});