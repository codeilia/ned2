(function(){function a(m){function k(){this.deflated||(m.widgets.focused==this.widget&&(this.focused=!0),m.widgets.destroy(this.widget),this.deflated=!0)}function r(){var x=m.editable(),y=m.document;if(this.deflated){this.widget=m.widgets.initOn(this.element,"image",this.widget.data),this.widget.inline&&!(new CKEDITOR.dom.elementPath(this.widget.wrapper,x)).block&&(x=y.createElement(m.activeEnterMode==CKEDITOR.ENTER_P?"p":"div"),x.replace(this.widget.wrapper),this.widget.wrapper.move(x)),this.focused&&(this.widget.focus(),delete this.focused),delete this.deflated}else{var u=this.widget,x=q,y=u.wrapper,w=u.data.align,u=u.data.hasCaption;if(x){for(var v=3;v--;){y.removeClass(x[v])}"center"==w?u&&y.addClass(x[1]):"none"!=w&&y.addClass(x[c[w]])}else{"center"==w?(u?y.setStyle("text-align","center"):y.removeStyle("text-align"),y.removeStyle("float")):("none"==w?y.removeStyle("float"):y.setStyle("float",w),y.removeStyle("text-align"))}}}var q=m.config.image2_alignClasses,n=m.config.image2_captionedClass;return{allowedContent:t(m),requiredContent:"img[src,alt]",features:s(m),styleableElements:"img figure",contentTransformations:[["img[width]: sizeToAttribute"]],editables:{caption:{selector:"figcaption",allowedContent:"br em strong sub sup u s; a[!href]"}},parts:{image:"img",caption:"figcaption"},dialog:"image2",template:'\x3cimg alt\x3d"" src\x3d"" /\x3e',data:function(){var v=this.features;this.data.hasCaption&&!m.filter.checkFeature(v.caption)&&(this.data.hasCaption=!1);"none"==this.data.align||m.filter.checkFeature(v.align)||(this.data.align="none");this.shiftState({widget:this,element:this.element,oldData:this.oldData,newData:this.data,deflate:k,inflate:r});this.data.link?this.parts.link||(this.parts.link=this.parts.image.getParent()):this.parts.link&&delete this.parts.link;this.parts.image.setAttributes({src:this.data.src,"data-cke-saved-src":this.data.src,alt:this.data.alt});if(this.oldData&&!this.oldData.hasCaption&&this.data.hasCaption){for(var w in this.data.classes){this.parts.image.removeClass(w)}}if(m.filter.checkFeature(v.dimension)){v=this.data;v={width:v.width,height:v.height};w=this.parts.image;for(var u in v){v[u]?w.setAttribute(u,v[u]):w.removeAttribute(u)}}this.oldData=CKEDITOR.tools.extend({},this.data)},init:function(){var u=CKEDITOR.plugins.image2,x=this.parts.image,w={hasCaption:!!this.parts.caption,src:x.getAttribute("src"),alt:x.getAttribute("alt")||"",width:x.getAttribute("width")||"",height:x.getAttribute("height")||"",lock:this.ready?u.checkHasNaturalRatio(x):!0},v=x.getAscendant("a");v&&this.wrapper.contains(v)&&(this.parts.link=v);w.align||(x=w.hasCaption?this.element:x,q?(x.hasClass(q[0])?w.align="left":x.hasClass(q[2])&&(w.align="right"),w.align?x.removeClass(q[c[w.align]]):w.align="none"):(w.align=x.getStyle("float")||"none",x.removeStyle("float")));m.plugins.link&&this.parts.link&&(w.link=u.getLinkAttributesParser()(m,this.parts.link),(x=w.link.advanced)&&x.advCSSClasses&&(x.advCSSClasses=CKEDITOR.tools.trim(x.advCSSClasses.replace(/cke_\S+/,""))));this.wrapper[(w.hasCaption?"remove":"add")+"Class"]("cke_image_nocaption");this.setData(w);m.filter.checkFeature(this.features.dimension)&&!0!==m.config.image2_disableResizer&&p(this);this.shiftState=u.stateShifter(this.editor);this.on("contextMenu",function(y){y.data.image=CKEDITOR.TRISTATE_OFF;if(this.parts.link||this.wrapper.getAscendant("a")){y.data.link=y.data.unlink=CKEDITOR.TRISTATE_OFF}});this.on("dialog",function(y){y.data.widget=this},this)},addClass:function(u){e(this).addClass(u)},hasClass:function(u){return e(this).hasClass(u)},removeClass:function(u){e(this).removeClass(u)},getClasses:function(){var u=new RegExp("^("+[].concat(n,q).join("|")+")$");return function(){var v=this.repository.parseElementClasses(e(this).getAttribute("class")),w;for(w in v){u.test(w)&&delete v[w]}return v}}(),upcast:o(m),downcast:l(m),getLabel:function(){return this.editor.lang.widget.label.replace(/%1/,(this.data.alt||"")+" "+this.pathName)}}}function o(m){var k=d(m),n=m.config.image2_captionedClass;return function(q,u){var w={width:1,height:1},x=q.name,r;if(!q.attributes["data-cke-realelement"]&&(k(q)?("div"==x&&(r=q.getFirst("figure"))&&(q.replaceWith(r),q=r),u.align="center",r=q.getFirst("img")||q.getFirst("a").getFirst("img")):"figure"==x&&q.hasClass(n)?r=q.getFirst("img")||q.getFirst("a").getFirst("img"):b(q)&&(r="a"==q.name?q.children[0]:q),r)){for(var v in w){(w=r.attributes[v])&&w.match(j)&&delete r.attributes[v]}return q}}}function l(m){var k=m.config.image2_alignClasses;return function(n){var r="a"==n.name?n.getFirst():n,q=r.attributes,u=this.data.align;if(!this.inline){var v=n.getFirst("span");v&&v.replaceWith(v.getFirst({img:1,a:1}))}u&&"none"!=u&&(v=CKEDITOR.tools.parseCssText(q.style||""),"center"==u&&"figure"==n.name?n=n.wrapWith(new CKEDITOR.htmlParser.element("div",k?{"class":k[1]}:{style:"text-align:center"})):u in {left:1,right:1}&&(k?r.addClass(k[c[u]]):v["float"]=u),k||CKEDITOR.tools.isEmpty(v)||(q.style=CKEDITOR.tools.writeCssText(v)));return n}}function d(m){var k=m.config.image2_captionedClass,q=m.config.image2_alignClasses,n={figure:1,a:1,img:1};return function(r){if(!(r.name in {div:1,p:1})){return !1}var u=r.children;if(1!==u.length){return !1}u=u[0];if(!(u.name in n)){return !1}if("p"==r.name){if(!b(u)){return !1}}else{if("figure"==u.name){if(!u.hasClass(k)){return !1}}else{if(m.enterMode==CKEDITOR.ENTER_P||!b(u)){return !1}}}return(q?r.hasClass(q[1]):"center"==CKEDITOR.tools.parseCssText(r.attributes.style||"",!0)["text-align"])?!0:!1}}function b(k){return"img"==k.name?!0:"a"==k.name?1==k.children.length&&k.getFirst("img"):!1}function p(m){var k=m.editor,u=k.editable(),r=k.document,q=m.resizer=r.createElement("span");q.addClass("cke_image_resizer");q.setAttribute("title",k.lang.image2.resizer);q.append(new CKEDITOR.dom.text("",r));if(m.inline){m.wrapper.append(q)}else{var v=m.parts.link||m.parts.image,w=v.getParent(),n=r.createElement("span");n.addClass("cke_image_resizer_wrapper");n.append(v);n.append(q);m.element.append(n,!0);w.is("span")&&w.remove()}q.on("mousedown",function(W){function S(z,x,B){var A=CKEDITOR.document,y=[];r.equals(A)||y.push(A.on(z,x));y.push(r.on(z,x));if(B){for(z=y.length;z--;){B.push(y.pop())}}}function V(){J=R+P*F;I=Math.round(J/H)}function G(){I=N-O;J=Math.round(I*H)}var U=m.parts.image,P="right"==m.data.align?-1:1,T=W.data.$.screenX,C=W.data.$.screenY,R=U.$.clientWidth,N=U.$.clientHeight,H=R/N,Q=[],L="cke_image_s"+(~P?"e":"w"),M,J,I,D,F,O,E;k.fire("saveSnapshot");S("mousemove",function(x){M=x.data.$;F=M.screenX-T;O=C-M.screenY;E=Math.abs(F/O);1==P?0>=F?0>=O?V():E>=H?V():G():0>=O?E>=H?G():V():G():0>=F?0>=O?E>=H?G():V():G():0>=O?V():E>=H?V():G();15<=J&&15<=I?(U.setAttributes({width:J,height:I}),D=!0):D=!1},Q);S("mouseup",function(){for(var x;x=Q.pop();){x.removeListener()}u.removeClass(L);q.removeClass("cke_image_resizing");D&&(m.setData({width:J,height:I}),k.fire("saveSnapshot"));D=!1},Q);u.addClass(L);q.addClass("cke_image_resizing")});m.on("data",function(){q["right"==m.data.align?"addClass":"removeClass"]("cke_image_resizer_left")})}function i(m){var k=[],n;return function(r){var q=m.getCommand("justify"+r);if(q){k.push(function(){q.refresh(m,m.elementPath())});if(r in {right:1,left:1,center:1}){q.on("exec",function(u){var v=f(m);if(v){v.setData("align",r);for(v=k.length;v--;){k[v]()}u.cancel()}})}q.on("refresh",function(u){var w=f(m),v={right:1,left:1,center:1};w&&(void 0===n&&(n=m.filter.checkFeature(m.widgets.registered.image.features.align)),n?this.setState(w.data.align==r?CKEDITOR.TRISTATE_ON:r in v?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED):this.setState(CKEDITOR.TRISTATE_DISABLED),u.cancel())})}}}function h(k){k.plugins.link&&(CKEDITOR.on("dialogDefinition",function(m){m=m.data;if("link"==m.name){m=m.definition;var q=m.onShow,n=m.onOk;m.onShow=function(){var r=f(k);r&&(r.inline?!r.wrapper.getAscendant("a"):1)?this.setupContent(r.data.link||{}):q.apply(this,arguments)};m.onOk=function(){var r=f(k);if(r&&(r.inline?!r.wrapper.getAscendant("a"):1)){var u={};this.commitContent(u);r.setData("link",u)}else{n.apply(this,arguments)}}}}),k.getCommand("unlink").on("exec",function(m){var n=f(k);n&&n.parts.link&&(n.setData("link",null),this.refresh(k,k.elementPath()),m.cancel())}),k.getCommand("unlink").on("refresh",function(m){var n=f(k);n&&(this.setState(n.data.link||n.wrapper.getAscendant("a")?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED),m.cancel())}))}function f(k){return(k=k.widgets.focused)&&"image"==k.name?k:null}function t(m){var k=m.config.image2_alignClasses;m={div:{match:d(m)},p:{match:d(m)},img:{attributes:"!src,alt,width,height"},figure:{classes:"!"+m.config.image2_captionedClass},figcaption:!0};k?(m.div.classes=k[1],m.p.classes=m.div.classes,m.img.classes=k[0]+","+k[2],m.figure.classes+=","+m.img.classes):(m.div.styles="text-align",m.p.styles="text-align",m.img.styles="float",m.figure.styles="float,display");return m}function s(k){k=k.config.image2_alignClasses;return{dimension:{requiredContent:"img[width,height]"},align:{requiredContent:"img"+(k?"("+k[0]+")":"{float}")},caption:{requiredContent:"figcaption"}}}function e(k){return k.data.hasCaption?k.element:k.parts.image}var g=new CKEDITOR.template('\x3cfigure class\x3d"{captionedClass}"\x3e\x3cimg alt\x3d"" src\x3d"" /\x3e\x3cfigcaption\x3e{captionPlaceholder}\x3c/figcaption\x3e\x3c/figure\x3e'),c={left:0,center:1,right:2},j=/^\s*(\d+\%)\s*$/i;CKEDITOR.plugins.add("image2",{lang:"af,ar,bg,bn,bs,ca,cs,cy,da,de,de-ch,el,en,en-au,en-ca,en-gb,eo,es,et,eu,fa,fi,fo,fr,fr-ca,gl,gu,he,hi,hr,hu,id,is,it,ja,ka,km,ko,ku,lt,lv,mk,mn,ms,nb,nl,no,pl,pt,pt-br,ro,ru,si,sk,sl,sq,sr,sr-latn,sv,th,tr,tt,ug,uk,vi,zh,zh-cn",requires:"widget,dialog",icons:"image",hidpi:!0,onLoad:function(){CKEDITOR.addCss(".cke_image_nocaption{line-height:0}.cke_editable.cke_image_sw, .cke_editable.cke_image_sw *{cursor:sw-resize !important}.cke_editable.cke_image_se, .cke_editable.cke_image_se *{cursor:se-resize !important}.cke_image_resizer{display:none;position:absolute;width:10px;height:10px;bottom:-5px;right:-5px;background:#000;outline:1px solid #fff;line-height:0;cursor:se-resize;}.cke_image_resizer_wrapper{position:relative;display:inline-block;line-height:0;}.cke_image_resizer.cke_image_resizer_left{right:auto;left:-5px;cursor:sw-resize;}.cke_widget_wrapper:hover .cke_image_resizer,.cke_image_resizer.cke_image_resizing{display:block}.cke_widget_wrapper\x3ea{display:inline-block}")},init:function(m){var k=m.config,q=m.lang.image2,n=a(m);k.filebrowserImage2BrowseUrl=k.filebrowserImageBrowseUrl;k.filebrowserImage2UploadUrl=k.filebrowserImageUploadUrl;n.pathName=q.pathName;n.editables.caption.pathName=q.pathNameCaption;m.widgets.add("image",n);m.ui.addButton&&m.ui.addButton("Image",{label:m.lang.common.image,command:"image",toolbar:"insert,10"});m.contextMenu&&(m.addMenuGroup("image",10),m.addMenuItem("image",{label:q.menu,command:"image",group:"image"}));CKEDITOR.dialog.add("image2",this.path+"dialogs/image2.js")},afterInit:function(m){var k={left:1,right:1,center:1,block:1},q=i(m),n;for(n in k){q(n)}h(m)}});CKEDITOR.plugins.image2={stateShifter:function(y){function x(z,k){var A={};q?A.attributes={"class":q[1]}:A.styles={"text-align":"center"};A=r.createElement(z.activeEnterMode==CKEDITOR.ENTER_P?"p":"div",A);u(A,k);k.move(A);return A}function u(k,A){if(A.getParent()){var z=y.createRange();z.moveToPosition(A,CKEDITOR.POSITION_BEFORE_START);A.remove();w.insertElementIntoRange(k,z)}else{k.replace(A)}}var r=y.document,q=y.config.image2_alignClasses,v=y.config.image2_captionedClass,w=y.editable(),n=["hasCaption","align","link"],m={align:function(B,A,z){var k=B.element;B.changed.align?B.newData.hasCaption||("center"==z&&(B.deflate(),B.element=x(y,k)),B.changed.hasCaption||"center"!=A||"center"==z||(B.deflate(),A=k.findOne("a,img"),A.replace(k),B.element=A)):"center"==z&&B.changed.hasCaption&&!B.newData.hasCaption&&(B.deflate(),B.element=x(y,k));!q&&k.is("figure")&&("center"==z?k.setStyle("display","inline-block"):k.removeStyle("display"))},hasCaption:function(k,A,z){k.changed.hasCaption&&(A=k.element.is({img:1,a:1})?k.element:k.element.findOne("a,img"),k.deflate(),z?(z=CKEDITOR.dom.element.createFromHtml(g.output({captionedClass:v,captionPlaceholder:y.lang.image2.captionPlaceholder}),r),u(z,k.element),A.replace(z.findOne("img")),k.element=z):(A.replace(k.element),k.element=A))},link:function(z,F,E){if(z.changed.link){var D=z.element.is("img")?z.element:z.element.findOne("img"),C=z.element.is("a")?z.element:z.element.findOne("a"),B=z.element.is("a")&&!E||z.element.is("img")&&E,A;B&&z.deflate();E?(F||(A=r.createElement("a",{attributes:{href:z.newData.link.url}}),A.replace(D),D.move(A)),E=CKEDITOR.plugins.image2.getLinkAttributesGetter()(y,E),CKEDITOR.tools.isEmpty(E.set)||(A||C).setAttributes(E.set),E.removed.length&&(A||C).removeAttributes(E.removed)):(E=C.findOne("img"),E.replace(C),A=E);B&&(z.element=A)}}};return function(z){var k,A;z.changed={};for(A=0;A<n.length;A++){k=n[A],z.changed[k]=z.oldData?z.oldData[k]!==z.newData[k]:!1}for(A=0;A<n.length;A++){k=n[A],m[k](z,z.oldData?z.oldData[k]:null,z.newData[k])}z.inflate()}},checkHasNaturalRatio:function(m){var k=m.$;m=this.getNatural(m);return Math.round(k.clientWidth/m.width*m.height)==k.clientHeight||Math.round(k.clientHeight/m.height*m.width)==k.clientWidth},getNatural:function(m){if(m.$.naturalWidth){m={width:m.$.naturalWidth,height:m.$.naturalHeight}}else{var k=new Image;k.src=m.getAttribute("src");m={width:k.width,height:k.height}}return m},getLinkAttributesGetter:function(){return CKEDITOR.plugins.link.getLinkAttributes},getLinkAttributesParser:function(){return CKEDITOR.plugins.link.parseLinkAttributes}}})();CKEDITOR.config.image2_captionedClass="image";