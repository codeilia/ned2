(function(){function b(l,m,n,k){if(!l.isReadOnly()&&!l.equals(n.editable())){CKEDITOR.dom.element.setMarker(k,l,"bidi_processed",1);k=l;for(var o=n.editable();(k=k.getParent())&&!k.equals(o);){if(k.getCustomData("bidi_processed")){l.removeStyle("direction");l.removeAttribute("dir");return}}k="useComputedState" in n.config?n.config.useComputedState:1;(k?l.getComputedStyle("direction"):l.getStyle("direction")||l.hasAttribute("dir"))!=m&&(l.removeStyle("direction"),k?(l.removeAttribute("dir"),m!=l.getComputedStyle("direction")&&l.setAttribute("dir",m)):l.setAttribute("dir",m),n.forceNextSelectionCheck())}}function h(l,m,n){var k=l.getCommonAncestor(!1,!0);l=l.clone();l.enlarge(n==CKEDITOR.ENTER_BR?CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS:CKEDITOR.ENLARGE_BLOCK_CONTENTS);if(l.checkBoundaryOfElement(k,CKEDITOR.START)&&l.checkBoundaryOfElement(k,CKEDITOR.END)){for(var o;k&&k.type==CKEDITOR.NODE_ELEMENT&&(o=k.getParent())&&1==o.getChildCount()&&!(k.getName() in m);){k=o}return k.type==CKEDITOR.NODE_ELEMENT&&k.getName() in m&&k}}function c(k){return{context:"p",allowedContent:{"h1 h2 h3 h4 h5 h6 table ul ol blockquote div tr p div li td":{propertiesOnly:!0,attributes:"dir"}},requiredContent:"p[dir]",refresh:function(m,p){var l=m.config.useComputedState,q,l=void 0===l||l;if(!l){q=p.lastElement;for(var n=m.editable();q&&!(q.getName() in i||q.equals(n));){var o=q.getParent();if(!o){break}q=o}}q=q||p.block||p.blockLimit;q.equals(m.editable())&&(n=m.getSelection().getRanges()[0].getEnclosedNode())&&n.type==CKEDITOR.NODE_ELEMENT&&(q=n);q&&(l=l?q.getComputedStyle("direction"):q.getStyle("direction")||q.getAttribute("dir"),m.getCommand("bidirtl").setState("rtl"==l?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF),m.getCommand("bidiltr").setState("ltr"==l?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF));l=(p.block||p.blockLimit||m.editable()).getDirection(1);l!=(m._.selDir||m.lang.dir)&&(m._.selDir=l,m.fire("contentDirChanged",l))},exec:function(w){var y=w.getSelection(),A=w.config.enterMode,z=y.getRanges();if(z&&z.length){for(var u={},x=y.createBookmarks(),z=z.createIterator(),v,s=0;v=z.getNextRange(1);){var t=v.getEnclosedNode();t&&(!t||t.type==CKEDITOR.NODE_ELEMENT&&t.getName() in a)||(t=h(v,j,A));t&&b(t,k,w,u);var r=new CKEDITOR.dom.walker(v),q=x[s].startNode,o=x[s++].endNode;r.evaluator=function(l){var n=A==CKEDITOR.ENTER_P?"p":"div",m;if(m=(l?l.type==CKEDITOR.NODE_ELEMENT:!1)&&l.getName() in j){if(n=l.is(n)){n=(n=l.getParent())?n.type==CKEDITOR.NODE_ELEMENT:!1}m=!(n&&l.getParent().is("blockquote"))}return !!(m&&l.getPosition(q)&CKEDITOR.POSITION_FOLLOWING&&(l.getPosition(o)&CKEDITOR.POSITION_PRECEDING+CKEDITOR.POSITION_CONTAINS)==CKEDITOR.POSITION_PRECEDING)};for(;t=r.next();){b(t,k,w,u)}v=v.createIterator();for(v.enlargeBr=A!=CKEDITOR.ENTER_BR;t=v.getNextParagraph(A==CKEDITOR.ENTER_P?"p":"div");){b(t,k,w,u)}}CKEDITOR.dom.element.clearAllMarkers(u);w.forceNextSelectionCheck();y.selectBookmarks(x);w.focus()}}}}function g(l){var m=l==f.setAttribute,n=l==f.removeAttribute,k=/\bdirection\s*:\s*(.*?)\s*(:?$|;)/;return function(r,o){if(!this.isReadOnly()){var q;if(q=r==(m||n?"dir":"direction")||"style"==r&&(n||k.test(o))){l:{q=this;for(var p=q.getDocument().getBody().getParent();q;){if(q.equals(p)){q=!1;break l}q=q.getParent()}q=!0}q=!q}if(q&&(q=this.getDirection(1),p=l.apply(this,arguments),q!=this.getDirection(1))){return this.getDocument().fire("dirChanged",this),p}}return l.apply(this,arguments)}}var j={table:1,ul:1,ol:1,blockquote:1,div:1},a={},i={};CKEDITOR.tools.extend(a,j,{tr:1,p:1,div:1,li:1});CKEDITOR.tools.extend(i,a,{td:1});CKEDITOR.plugins.add("bidi",{lang:"af,ar,bg,bn,bs,ca,cs,cy,da,de,de-ch,el,en,en-au,en-ca,en-gb,eo,es,et,eu,fa,fi,fo,fr,fr-ca,gl,gu,he,hi,hr,hu,id,is,it,ja,ka,km,ko,ku,lt,lv,mk,mn,ms,nb,nl,no,pl,pt,pt-br,ro,ru,si,sk,sl,sq,sr,sr-latn,sv,th,tr,tt,ug,uk,vi,zh,zh-cn",icons:"bidiltr,bidirtl",hidpi:!0,init:function(k){function l(n,r,q,p,o){k.addCommand(q,new CKEDITOR.command(k,p));k.ui.addButton&&k.ui.addButton(n,{label:r,command:q,toolbar:"bidi,"+o})}if(!k.blockless){var m=k.lang.bidi;l("BidiLtr",m.ltr,"bidiltr",c("ltr"),10);l("BidiRtl",m.rtl,"bidirtl",c("rtl"),20);k.on("contentDom",function(){k.document.on("dirChanged",function(n){k.fire("dirChanged",{node:n.data,dir:n.data.getDirection(1)})})});k.on("contentDirChanged",function(n){n=(k.lang.dir!=n.data?"add":"remove")+"Class";var o=k.ui.space(k.config.toolbarLocation);if(o){o[n]("cke_mixed_dir_content")}})}}});for(var f=CKEDITOR.dom.element.prototype,d=["setStyle","removeStyle","setAttribute","removeAttribute"],e=0;e<d.length;e++){f[d[e]]=CKEDITOR.tools.override(f[d[e]],g)}})();