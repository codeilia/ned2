(function(){function a(e,d,f){this.editor=e;this.notification=null;this._message=new CKEDITOR.template(d);this._singularMessage=f?new CKEDITOR.template(f):null;this._tasks=[];this._doneTasks=this._doneWeights=this._totalWeights=0}function b(c){this._weight=c||1;this._doneWeight=0;this._isCanceled=!1}CKEDITOR.plugins.add("notificationaggregator",{requires:"notification"});a.prototype={createTask:function(e){e=e||{};var d=!this.notification,f;d&&(this.notification=this._createNotification());f=this._addTask(e);f.on("updated",this._onTaskUpdate,this);f.on("done",this._onTaskDone,this);f.on("canceled",function(){this._removeTask(f)},this);this.update();d&&this.notification.show();return f},update:function(){this._updateNotification();this.isFinished()&&this.fire("finished")},getPercentage:function(){return 0===this.getTaskCount()?1:this._doneWeights/this._totalWeights},isFinished:function(){return this.getDoneTaskCount()===this.getTaskCount()},getTaskCount:function(){return this._tasks.length},getDoneTaskCount:function(){return this._doneTasks},_updateNotification:function(){this.notification.update({message:this._getNotificationMessage(),progress:this.getPercentage()})},_getNotificationMessage:function(){var d=this.getTaskCount(),c={current:this.getDoneTaskCount(),max:d,percentage:Math.round(100*this.getPercentage())};return(1==d&&this._singularMessage?this._singularMessage:this._message).output(c)},_createNotification:function(){return new CKEDITOR.plugins.notification(this.editor,{type:"progress"})},_addTask:function(c){c=new b(c.weight);this._tasks.push(c);this._totalWeights+=c._weight;return c},_removeTask:function(d){var c=CKEDITOR.tools.indexOf(this._tasks,d);-1!==c&&(d._doneWeight&&(this._doneWeights-=d._doneWeight),this._totalWeights-=d._weight,this._tasks.splice(c,1),this.update())},_onTaskUpdate:function(c){this._doneWeights+=c.data;this.update()},_onTaskDone:function(){this._doneTasks+=1;this.update()}};CKEDITOR.event.implementOn(a.prototype);b.prototype={done:function(){this.update(this._weight)},update:function(d){if(!this.isDone()&&!this.isCanceled()){d=Math.min(this._weight,d);var c=d-this._doneWeight;this._doneWeight=d;this.fire("updated",c);this.isDone()&&this.fire("done")}},cancel:function(){this.isDone()||this.isCanceled()||(this._isCanceled=!0,this.fire("canceled"))},isDone:function(){return this._weight===this._doneWeight},isCanceled:function(){return this._isCanceled}};CKEDITOR.event.implementOn(b.prototype);CKEDITOR.plugins.notificationAggregator=a;CKEDITOR.plugins.notificationAggregator.task=b})();