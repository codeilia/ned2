(function(){function a(i,j){CKEDITOR.tools.extend(this,{editor:i,editable:i.editable(),doc:i.document,win:i.window},j,!0);this.inline=this.editable.isInline();this.inline||(this.frame=this.win.getFrame());this.target=this[this.inline?"editable":"doc"]}function h(i,j){CKEDITOR.tools.extend(this,j,{editor:i},!0)}function g(j,m){var i=j.editable();CKEDITOR.tools.extend(this,{editor:j,editable:i,inline:i.isInline(),doc:j.document,win:j.window,container:CKEDITOR.document.getBody(),winTop:CKEDITOR.document.getWindow()},m,!0);this.hidden={};this.visible={};this.inline||(this.frame=this.win.getFrame());this.queryViewport();var n=CKEDITOR.tools.bind(this.queryViewport,this),l=CKEDITOR.tools.bind(this.hideVisible,this),k=CKEDITOR.tools.bind(this.removeAll,this);i.attachListener(this.winTop,"resize",n);i.attachListener(this.winTop,"scroll",n);i.attachListener(this.winTop,"resize",l);i.attachListener(this.win,"scroll",l);i.attachListener(this.inline?i:this.frame,"mouseout",function(p){var o=p.data.$.clientX;p=p.data.$.clientY;this.queryViewport();(o<=this.rect.left||o>=this.rect.right||p<=this.rect.top||p>=this.rect.bottom)&&this.hideVisible();(0>=o||o>=this.winTopPane.width||0>=p||p>=this.winTopPane.height)&&this.hideVisible()},this);i.attachListener(j,"resize",n);i.attachListener(j,"mode",k);j.on("destroy",k);this.lineTpl=(new CKEDITOR.template('\x3cdiv data-cke-lineutils-line\x3d"1" class\x3d"cke_reset_all" style\x3d"{lineStyle}"\x3e\x3cspan style\x3d"{tipLeftStyle}"\x3e\x26nbsp;\x3c/span\x3e\x3cspan style\x3d"{tipRightStyle}"\x3e\x26nbsp;\x3c/span\x3e\x3c/div\x3e')).output({lineStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},d,this.lineStyle,!0)),tipLeftStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},f,{left:"0px","border-left-color":"red","border-width":"6px 0 6px 6px"},this.tipCss,this.tipLeftStyle,!0)),tipRightStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},f,{right:"0px","border-right-color":"red","border-width":"6px 6px 6px 0"},this.tipCss,this.tipRightStyle,!0))})}function b(i){var j;if(j=i&&i.type==CKEDITOR.NODE_ELEMENT){j=!(e[i.getComputedStyle("float")]||e[i.getAttribute("align")])}return j&&!c[i.getComputedStyle("position")]}CKEDITOR.plugins.add("lineutils");CKEDITOR.LINEUTILS_BEFORE=1;CKEDITOR.LINEUTILS_AFTER=2;CKEDITOR.LINEUTILS_INSIDE=4;a.prototype={start:function(r){var o=this,q=this.editor,p=this.doc,n,l,m,j,i=CKEDITOR.tools.eventsBuffer(50,function(){q.readOnly||"wysiwyg"!=q.mode||(o.relations={},(l=p.$.elementFromPoint(m,j))&&l.nodeType&&(n=new CKEDITOR.dom.element(l),o.traverseSearch(n),isNaN(m+j)||o.pixelSearch(n,m,j),r&&r(o.relations,m,j)))});this.listener=this.editable.attachListener(this.target,"mousemove",function(k){m=k.data.$.clientX;j=k.data.$.clientY;i.input()});this.editable.attachListener(this.inline?this.editable:this.frame,"mouseout",function(){i.reset()})},stop:function(){this.listener&&this.listener.removeListener()},getRange:function(){var i={};i[CKEDITOR.LINEUTILS_BEFORE]=CKEDITOR.POSITION_BEFORE_START;i[CKEDITOR.LINEUTILS_AFTER]=CKEDITOR.POSITION_AFTER_END;i[CKEDITOR.LINEUTILS_INSIDE]=CKEDITOR.POSITION_AFTER_START;return function(k){var j=this.editor.createRange();j.moveToPosition(this.relations[k.uid].element,i[k.type]);return j}}(),store:function(){function i(k,j,m){var l=k.getUniqueId();l in m?m[l].type|=j:m[l]={element:k,type:j}}return function(k,j){var l;j&CKEDITOR.LINEUTILS_AFTER&&b(l=k.getNext())&&l.isVisible()&&(i(l,CKEDITOR.LINEUTILS_BEFORE,this.relations),j^=CKEDITOR.LINEUTILS_AFTER);j&CKEDITOR.LINEUTILS_INSIDE&&b(l=k.getFirst())&&l.isVisible()&&(i(l,CKEDITOR.LINEUTILS_BEFORE,this.relations),j^=CKEDITOR.LINEUTILS_INSIDE);i(k,j,this.relations)}}(),traverseSearch:function(j){var k,i,l;do{if(l=j.$["data-cke-expando"],!(l&&l in this.relations)){if(j.equals(this.editable)){break}if(b(j)){for(k in this.lookups){(i=this.lookups[k](j))&&this.store(j,i)}}}}while((!j||j.type!=CKEDITOR.NODE_ELEMENT||"true"!=j.getAttribute("contenteditable"))&&(j=j.getParent()))},pixelSearch:function(){function i(l,r,q,o,p){for(var n=0,m;p(q);){q+=o;if(25==++n){break}if(m=this.doc.$.elementFromPoint(r,q)){if(m==l){n=0}else{if(j(l,m)&&(n=0,b(m=new CKEDITOR.dom.element(m)))){return m}}}}}var j=CKEDITOR.env.ie||CKEDITOR.env.webkit?function(k,l){return k.contains(l)}:function(k,l){return !!(k.compareDocumentPosition(l)&16)};return function(k,o,n){var l=this.win.getViewPaneSize().height,m=i.call(this,k.$,o,n,-1,function(p){return 0<p});o=i.call(this,k.$,o,n,1,function(p){return p<l});if(m){for(this.traverseSearch(m);!m.getParent().equals(k);){m=m.getParent()}}if(o){for(this.traverseSearch(o);!o.getParent().equals(k);){o=o.getParent()}}for(;m||o;){m&&(m=m.getNext(b));if(!m||m.equals(o)){break}this.traverseSearch(m);o&&(o=o.getPrevious(b));if(!o||o.equals(m)){break}this.traverseSearch(o)}}}(),greedySearch:function(){this.relations={};for(var j=this.editable.getElementsByTag("*"),l=0,i,m,k;i=j.getItem(l++);){if(!i.equals(this.editable)&&i.type==CKEDITOR.NODE_ELEMENT&&(i.hasAttribute("contenteditable")||!i.isReadOnly())&&b(i)&&i.isVisible()){for(k in this.lookups){(m=this.lookups[k](i))&&this.store(i,m)}}}return this.relations}};h.prototype={locate:function(){function i(k,j){var l=k.element[j===CKEDITOR.LINEUTILS_BEFORE?"getPrevious":"getNext"]();return l&&b(l)?(k.siblingRect=l.getClientRect(),j==CKEDITOR.LINEUTILS_BEFORE?(k.siblingRect.bottom+k.elementRect.top)/2:(k.elementRect.bottom+k.siblingRect.top)/2):j==CKEDITOR.LINEUTILS_BEFORE?k.elementRect.top:k.elementRect.bottom}return function(k){var j;this.locations={};for(var l in k){j=k[l],j.elementRect=j.element.getClientRect(),j.type&CKEDITOR.LINEUTILS_BEFORE&&this.store(l,CKEDITOR.LINEUTILS_BEFORE,i(j,CKEDITOR.LINEUTILS_BEFORE)),j.type&CKEDITOR.LINEUTILS_AFTER&&this.store(l,CKEDITOR.LINEUTILS_AFTER,i(j,CKEDITOR.LINEUTILS_AFTER)),j.type&CKEDITOR.LINEUTILS_INSIDE&&this.store(l,CKEDITOR.LINEUTILS_INSIDE,(j.elementRect.top+j.elementRect.bottom)/2)}return this.locations}}(),sort:function(){var j,k,i,l;return function(p,n){j=this.locations;k=[];for(var o in j){for(var m in j[o]){if(i=Math.abs(p-j[o][m]),k.length){for(l=0;l<k.length;l++){if(i<k[l].dist){k.splice(l,0,{uid:+o,type:m,dist:i});break}}l==k.length&&k.push({uid:+o,type:m,dist:i})}else{k.push({uid:+o,type:m,dist:i})}}}return"undefined"!=typeof n?k.slice(0,n):k}}(),store:function(j,k,i){this.locations[j]||(this.locations[j]={});this.locations[j][k]=i}};var f={display:"block",width:"0px",height:"0px","border-color":"transparent","border-style":"solid",position:"absolute",top:"-6px"},d={height:"0px","border-top":"1px dashed red",position:"absolute","z-index":9999};g.prototype={removeAll:function(){for(var i in this.hidden){this.hidden[i].remove(),delete this.hidden[i]}for(i in this.visible){this.visible[i].remove(),delete this.visible[i]}},hideLine:function(i){var j=i.getUniqueId();i.hide();this.hidden[j]=i;delete this.visible[j]},showLine:function(i){var j=i.getUniqueId();i.show();this.visible[j]=i;delete this.hidden[j]},hideVisible:function(){for(var i in this.visible){this.hideLine(this.visible[i])}},placeLine:function(j,l){var i,m,k;if(i=this.getStyle(j.uid,j.type)){for(k in this.visible){if(this.visible[k].getCustomData("hash")!==this.hash){m=this.visible[k];break}}if(!m){for(k in this.hidden){if(this.hidden[k].getCustomData("hash")!==this.hash){this.showLine(m=this.hidden[k]);break}}}m||this.showLine(m=this.addLine());m.setCustomData("hash",this.hash);this.visible[m.getUniqueId()]=m;m.setStyles(i);l&&l(m)}},getStyle:function(j,m){var i=this.relations[j],n=this.locations[j][m],l={};l.width=i.siblingRect?Math.max(i.siblingRect.width,i.elementRect.width):i.elementRect.width;l.top=this.inline?n+this.winTopScroll.y-this.rect.relativeY:this.rect.top+this.winTopScroll.y+n;if(l.top-this.winTopScroll.y<this.rect.top||l.top-this.winTopScroll.y>this.rect.bottom){return !1}this.inline?l.left=i.elementRect.left-this.rect.relativeX:(0<i.elementRect.left?l.left=this.rect.left+i.elementRect.left:(l.width+=i.elementRect.left,l.left=this.rect.left),0<(i=l.left+l.width-(this.rect.left+this.winPane.width))&&(l.width-=i));l.left+=this.winTopScroll.x;for(var k in l){l[k]=CKEDITOR.tools.cssLength(l[k])}return l},addLine:function(){var i=CKEDITOR.dom.element.createFromHtml(this.lineTpl);i.appendTo(this.container);return i},prepare:function(i,j){this.relations=i;this.locations=j;this.hash=Math.random()},cleanup:function(){var i,j;for(j in this.visible){i=this.visible[j],i.getCustomData("hash")!==this.hash&&this.hideLine(i)}},queryViewport:function(){this.winPane=this.win.getViewPaneSize();this.winTopScroll=this.winTop.getScrollPosition();this.winTopPane=this.winTop.getViewPaneSize();this.rect=this.getClientRect(this.inline?this.editable:this.frame)},getClientRect:function(j){j=j.getClientRect();var k=this.container.getDocumentPosition(),i=this.container.getComputedStyle("position");j.relativeX=j.relativeY=0;"static"!=i&&(j.relativeY=k.y,j.relativeX=k.x,j.top-=j.relativeY,j.bottom-=j.relativeY,j.left-=j.relativeX,j.right-=j.relativeX);return j}};var e={left:1,right:1,center:1},c={absolute:1,fixed:1};CKEDITOR.plugins.lineutils={finder:a,locator:h,liner:g}})();